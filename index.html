<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Pay with Email Auth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        #login-screen {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-btn:hover {
            background: #5568d3;
        }

        #app-screen {
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #f1f3f4;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            color: #666;
        }

        .logout-btn:hover {
            background: #e8eaed;
        }

        .product {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .product-price {
            font-size: 24px;
            color: #667eea;
            font-weight: 700;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .check-payment-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .check-payment-btn:hover {
            background: #5568d3;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .info-box strong {
            color: #333;
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen">
            <h1>Welcome</h1>
            <p class="subtitle">Enter your email to continue</p>
            
            <div class="input-group">
                <label for="email-input">Email Address</label>
                <input 
                    type="email" 
                    id="email-input" 
                    placeholder="you@example.com"
                    required
                >
            </div>

            <button id="login-btn" class="auth-btn">Continue</button>

            <div class="info-box" style="margin-top: 20px;">
                <strong>üîí Simple & Secure</strong>
                Just enter your email - no password needed! We'll link your purchase to this email address.
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="app-screen">
            <h1>Premium Widget</h1>
            <p class="subtitle">Exclusive digital product</p>

            <div class="user-info">
                <div class="user-avatar" id="user-avatar"></div>
                <div class="user-details">
                    <div id="user-name" class="user-name">Welcome!</div>
                    <div id="user-email" class="user-email"></div>
                </div>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>

            <div id="payment-status"></div>

            <div class="product">
                <div class="product-image">üì±</div>
                <div class="product-details">
                    <div class="product-name">Premium Widget</div>
                    <div class="product-price">$29.99</div>
                </div>
            </div>

            <button id="check-payment-btn" class="check-payment-btn">
                Check My Purchase Status
            </button>

            <div style="margin: 20px 0;">
                <stripe-buy-button
                    id="stripe-buy-btn"
                    buy-button-id="buy_btn_1S7RnGDF77uOmLWrBAqZ5nZx"
                    publishable-key="pk_test_51S7RP5DF77uOmLWrIkGD9Uk0luxxdnXdFzCJ491TMXoqoiCoQEBqfb6gsLjfChi9Yi7FeMibyG73xELAAhA2qWXc00GZiOoMlt"
                >
                </stripe-buy-button>
            </div>

            <div class="info-box">
                <strong>How it works:</strong>
                1. Your email is automatically linked to your purchase<br>
                2. Click "Check My Purchase Status" to verify<br>
                3. Access your product instantly after payment<br><br>
                <strong>Test Card:</strong> 4242 4242 4242 4242
            </div>
        </div>
    </div>

    <script async src="https://js.stripe.com/v3/buy-button.js"></script>
    <script>
        let currentUser = null;

        // Login button handler
        document.getElementById('login-btn').addEventListener('click', function() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim();
            
            // Validate email
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Set current user
            currentUser = {
                email: email,
                name: email.split('@')[0],
                avatar: email.charAt(0).toUpperCase()
            };
            
            showAppScreen();
        });

        // Show app screen after login
        function showAppScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.avatar;

            // Pass user email to Stripe buy button
            // Wait for buy button to be ready
            setTimeout(() => {
                const buyButton = document.getElementById('stripe-buy-btn');
                if (buyButton) {
                    buyButton.setAttribute('customer-email', currentUser.email);
                    console.log('Set Stripe buy button email to:', currentUser.email);
                    
                    // Show reminder
                    const statusDiv = document.getElementById('payment-status');
                    statusDiv.innerHTML = `
                        <div class="status info">
                            ‚ÑπÔ∏è <strong>Important:</strong> When you checkout, make sure the email is: <strong>${currentUser.email}</strong><br>
                            This ensures we can link your purchase to your account.
                        </div>
                    `;
                }
            }, 500);
        }

        // Check payment status
        async function checkPaymentStatus() {
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = '<div class="status info">üîç Checking payment status...</div>';

            try {
                console.log('Checking payment for email:', currentUser.email);
                
                const response = await fetch('https://long-night-afa7.pinterest-subdomain.workers.dev/check-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: currentUser.email })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Full response data:', JSON.stringify(data, null, 2));
                
                if (data.error) {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå Error: ${data.error}
                        </div>
                    `;
                    return;
                }
                
                if (data.hasPaid) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Payment Verified!</strong><br>
                            You have ${data.paymentCount} successful payment(s).<br>
                            Customer ID: ${data.customer ? data.customer.id : 'N/A'}<br>
                            You have access to Premium Widget!
                        </div>
                    `;
                } else {
                    // Show detailed debug info
                    let debugInfo = `
                        <div class="status warning">
                            ‚ÑπÔ∏è No purchase found for <strong>${currentUser.email}</strong><br><br>
                            <strong>Debug Info:</strong><br>
                            Searching for: ${currentUser.email}<br>
                    `;
                    
                    if (data.customer) {
                        debugInfo += `Customer found: ${data.customer.email}<br>`;
                    } else {
                        debugInfo += `No customer found in Stripe with this email<br>`;
                    }
                    
                    debugInfo += `<br><strong>üí° Tip:</strong> Make sure the email you enter at checkout matches: ${currentUser.email}`;
                    debugInfo += `</div>`;
                    
                    statusDiv.innerHTML = debugInfo;
                }
            } catch (error) {
                console.error('Error details:', error);
                statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Error checking payment: ${error.message}<br>
                        <small>Check browser console for details</small>
                    </div>
                `;
            }
        }

        // Manual check payment button
        document.addEventListener('click', function(e) {
            if (e.target.id === 'check-payment-btn') {
                checkPaymentStatus();
            }
            
            if (e.target.id === 'logout-btn') {
                currentUser = null;
                document.getElementById('app-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('email-input').value = '';
                document.getElementById('payment-status').innerHTML = '';
            }
        });

        // Allow Enter key to login
        document.getElementById('email-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
    </script>
</body>
</html>